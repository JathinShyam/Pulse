services:
  web:
    build:
      context: .
      network: host
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app
      - ./logs:/app/logs
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
    env_file:
      - .env

  db:
    image: postgres:16
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_DB=pulse
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5433:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  celery:
    build:
      context: .
      network: host
    command: celery -A pulse worker -l info --logfile=/app/logs/celery.log -Q high_priority,low_priority
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env

  celery-beat:
    build:
      context: .
      network: host
    command: celery -A pulse beat -l info
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env

  celery-high:
    build:
      context: .
      network: host
    command: celery -A pulse worker -l info --logfile=/app/logs/celery-high.log -Q high_priority
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env

  celery-low:
    build:
      context: .
      network: host
    command: celery -A pulse worker -l info --logfile=/app/logs/celery-low.log -Q low_priority
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env

  flower:
    build:
      context: .
      network: host
    command: celery -A pulse flower --port=5555
    volumes:
      - .:/app
    ports:
      - "5555:5555"
    depends_on:
      - redis
    env_file:
      - .env

  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "1025:1025"
      - "8025:8025"

  # ==========================================================================
  # Observability Services
  # ==========================================================================

  dashboard:
    build:
      context: .
      network: host
    command: streamlit run dashboard/app.py --server.port=8501 --server.address=0.0.0.0
    volumes:
      - .:/app
    ports:
      - "8501:8501"
    depends_on:
      - db
      - redis
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/pulse
      - CELERY_BROKER_URL=redis://redis:6379/0

  metrics:
    build:
      context: .
      network: host
    command: python dashboard/metrics.py
    volumes:
      - .:/app
    ports:
      - "8001:8001"
    depends_on:
      - db
      - redis
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/pulse
      - CELERY_BROKER_URL=redis://redis:6379/0
      - METRICS_PORT=8001

  # ==========================================================================
  # Load Testing
  # ==========================================================================

  locust:
    build:
      context: .
      network: host
    command: locust -f locustfile.py --host http://web:8000
    volumes:
      - .:/app
    ports:
      - "8089:8089"
    depends_on:
      - web
      - redis
    env_file:
      - .env

  # ==========================================================================
  # Scaled Workers (for horizontal scaling demos)
  # Use: docker-compose up -d --scale celery-high=4 --scale celery-low=2
  # Or run these pre-defined extra workers for predictable scaling
  # ==========================================================================

  celery-high-2:
    build:
      context: .
      network: host
    command: celery -A pulse worker -l info --logfile=/app/logs/celery-high-2.log -Q high_priority -n high-worker-2@%h
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env
    profiles:
      - scale

  celery-high-3:
    build:
      context: .
      network: host
    command: celery -A pulse worker -l info --logfile=/app/logs/celery-high-3.log -Q high_priority -n high-worker-3@%h
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env
    profiles:
      - scale

  celery-high-4:
    build:
      context: .
      network: host
    command: celery -A pulse worker -l info --logfile=/app/logs/celery-high-4.log -Q high_priority -n high-worker-4@%h
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env
    profiles:
      - scale

  celery-low-2:
    build:
      context: .
      network: host
    command: celery -A pulse worker -l info --logfile=/app/logs/celery-low-2.log -Q low_priority -n low-worker-2@%h
    volumes:
      - .:/app
      - ./logs:/app/logs
    depends_on:
      - web
      - redis
    env_file:
      - .env
    profiles:
      - scale

volumes:
  postgres_data:
